<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Library Management Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="/student.css" />
</head>

<body>
  <div class="dashboard-container">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-brand">
        <i class="fas fa-book"></i>
        <span>Student Dashboard</span>
      </div>

      <nav class="sidebar-nav">
        <a href="#" onclick="handleNavClick('available-books')">
          <i class="fas fa-book"></i>
          <span>Available Books</span>
        </a>
        <a href="#" onclick="handleNavClick('my-books')">
          <i class="fas fa-book-reader"></i>
          <span>My Books</span>
        </a>
        <a href="#" onclick="toggleDarkMode()">
          <i class="fas fa-moon"></i>
          <span>Dark Mode</span>
        </a>
        <a href="" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </nav>

      <!-- Replace the sidebar-user div with this -->
      <div class="sidebar-user" onclick="toggleProfileMenu()">
        <div class="user-info">
          <div class="user-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="user-details">
            <h4 id="username">Loading...</h4>
            <p>Start learning</p>
          </div>
          <i class="fas fa-chevron-down" id="profile-chevron"></i>
        </div>
        <div class="profile-menu" id="profile-menu">
          <a href="#" onclick="showProfileSection('change-username')">
            <i class="fas fa-user-edit"></i> Change Username
          </a>
          <a href="#" onclick="showProfileSection('change-password')">
            <i class="fas fa-key"></i> Change Password
          </a>
          <a href="#" onclick="showProfileSection('contact-help')">
            <i class="fas fa-question-circle"></i> Contact Help
          </a>
          <a href="#" onclick="showProfileSection('recent-updates')">
            <i class="fas fa-bell"></i> Recent Updates
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="search-container">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search books..." id="book-search" />
        </div>
        <div class="top-actions">
          <button class="action-btn" onclick="showProfileSection('recent-updates')" title="Notifications">
            <i class="fas fa-bell"></i>
          </button>
        </div>
      </div>

      <!-- Welcome Section -->
      <div class="welcome-section">
        <h1>Welcome back, <span id="welcome-username">Student</span></h1>
        <p>Here's what's happening with your library account today.</p>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="profile-section" id="change-username-section">
          <h3>Change Username</h3>
          <form class="profile-form" onsubmit="changeUsername(event)">
            <div>
              <label>Current Username</label>
              <input type="text" id="current-username" readonly />
            </div>
            <div>
              <label>New Username</label>
              <input type="text" id="new-username" required minlength="3" maxlength="20" />
            </div>
            <div>
              <label>Confirm Password</label>
              <input type="password" id="username-confirm-password" required />
            </div>
            <button type="submit" class="btn-primary">
              <i class="fas fa-save"></i> Update Username
            </button>
            <div class="form-message" id="username-message"></div>
          </form>
        </div>

        <div class="profile-section" id="change-password-section">
          <h3>Change Password</h3>
          <form class="profile-form" onsubmit="changePassword(event)">
            <div>
              <label>Current Password</label>
              <input type="password" id="current-password" required />
            </div>
            <div>
              <label>New Password</label>
              <input type="password" id="new-password" required minlength="4" />
            </div>
            <div>
              <label>Confirm New Password</label>
              <input type="password" id="confirm-password" required />
            </div>
            <button type="submit" class="btn-primary">
              <i class="fas fa-save"></i> Update Password
            </button>
            <div class="form-message" id="password-message"></div>
          </form>
        </div>

        <div class="profile-section" id="contact-help-section">
          <h3>Contact Help</h3>
          <p>For any assistance, please contact our support team:</p>
          <p><i class="fas fa-envelope"></i> support@library.com</p>
          <p><i class="fas fa-phone"></i> +1 (555) 123-4567</p>
        </div>

        <div class="profile-section" id="recent-updates-section">
          <div class="section-header">
            <h3>Recent Updates</h3>
            <button class="action-btn" onclick="markAllAsRead()" title="Mark all as read">
              <i class="fas fa-check-double"></i> Mark Read
            </button>
          </div>
          <div class="updates-list" id="updates-list">
            <div class="empty-state">
              <i class="fas fa-spinner fa-spin"></i>
              <p>Loading updates...</p>
            </div>
          </div>
        </div>
      </div>
      <div id="stats-cards">
        <div class="stat-card purple">
          <div class="stat-card-content">
            <h3>Books Borrowed</h3>
            <div class="stat-number" id="borrowed-count">0</div>
            <div class="stat-subtitle">Enjoy your time</div>
          </div>
        </div>
        <div class="stat-card blue">
          <div class="stat-card-content">
            <h3>Books Active</h3>
            <div class="stat-number" id="active-count">0</div>
            <div class="stat-subtitle">Start reading</div>
          </div>
        </div>
        <div class="stat-card teal">
          <div class="stat-card-content">
            <h3>Book Expired</h3>
            <div class="stat-number" id="expired-count">0</div>
            <div class="stat-subtitle">Awaits renewal</div>
          </div>
        </div>
      </div>

      <!-- Available Books Section -->
      <div class="books-section" id="available-books">
        <div class="section-header">
          <div class="section-title">
            ðŸ“š Available Books
            <span class="section-count" id="available-books-count"></span>
          </div>
        </div>
        <div class="books-grid" id="books-grid">
          <!-- Books will be loaded here -->
        </div>
      </div>

      <!-- My Books Section -->
      <div class="books-section" id="my-books" style="display: none">
        <div class="section-header">
          <div class="section-title">
            ðŸ“– My Books
          </div>
          <div class="filter-controls">
            <select class="filter-select" id="book-filter">
              <option value="all">All Books</option>
              <option value="active">Active</option>
              <option value="expired">Expired</option>
            </select>
          </div>
        </div>
        <div class="books-grid" id="my-books-grid">
          <!-- Borrowed books will be loaded here -->
        </div>
      </div>
    </div>
  </div>
  <script>
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      const isDarkMode = document.body.classList.contains("dark-mode");
      localStorage.setItem("darkMode", isDarkMode);

      // Update icon
      const icon = event.currentTarget.querySelector("i");
      if (isDarkMode) {
        icon.classList.remove("fa-moon");
        icon.classList.add("fa-sun");
        event.currentTarget.innerHTML =
          '<i class="fas fa-sun"></i> Light Mode';
      } else {
        icon.classList.remove("fa-sun");
        icon.classList.add("fa-moon");
        event.currentTarget.innerHTML =
          '<i class="fas fa-moon"></i> Dark Mode';
      }
    }

    // Mobile menu functionality
    function toggleMobileMenu() {
      const sidebar = document.getElementById("sidebar");
      const toggleBtn = document.querySelector(".mobile-menu-toggle i");

      sidebar.classList.toggle("open");

      // Update toggle button icon
      if (sidebar.classList.contains("open")) {
        toggleBtn.classList.remove("fa-bars");
        toggleBtn.classList.add("fa-times");
      } else {
        toggleBtn.classList.remove("fa-times");
        toggleBtn.classList.add("fa-bars");
      }
    }

    // Close mobile menu when clicking outside
    function closeMobileMenu() {
      const sidebar = document.getElementById("sidebar");
      const toggleBtn = document.querySelector(".mobile-menu-toggle i");

      if (sidebar.classList.contains("open")) {
        sidebar.classList.remove("open");
        toggleBtn.classList.remove("fa-times");
        toggleBtn.classList.add("fa-bars");
      }
    }

    // Close mobile menu when clicking on a nav link
    function handleNavClick(sectionId) {
      showSection(sectionId);
      closeMobileMenu();
    }

    // Check for saved dark mode preference on load
    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        // Update the dark mode button text and icon
        const darkModeBtn = document.querySelector(
          '.nav-right a[onclick="toggleDarkMode()"]'
        );
        if (darkModeBtn) {
          darkModeBtn.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
        }
      }
    });
  </script>
  <script>
    // Function to fetch user data
    async function fetchUserData() {
      try {
        // Show loading state
        document.getElementById("username").innerHTML =
          '<span class="loading-spinner"></span>';

        // If using local storage (JWT authentication)
        const token = localStorage.getItem("token");
        if (token) {
          try {
            const decoded = jwt_decode(token);
            document.getElementById("username").textContent =
              decoded.username;
            document.getElementById("welcome-username").textContent =
              decoded.username;
            localStorage.setItem("username", decoded.username);
            return;
          } catch (e) {
            console.log("Token decode error:", e);
          }
        }

        // If using an API session to get user details
        const response = await fetch("/api/user/profile", {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!response.ok) throw new Error("User not logged in");

        const data = await response.json();
        document.getElementById("username").textContent = data.username;
        document.getElementById("welcome-username").textContent =
          data.username;
        localStorage.setItem("username", data.username);

        // Update stats
        updateStats();
      } catch (error) {
        console.error("Error fetching user data:", error);
        document.getElementById("username").textContent = "Guest";
      }
    }
    // Profile Menu Functions
    function toggleProfileMenu() {
      const menu = document.getElementById("profile-menu");
      const chevron = document.getElementById("profile-chevron");

      menu.classList.toggle("open");
      chevron.classList.toggle("rotate");
    }

    function showProfileSection(sectionId) {
      // Hide all profile sections
      document.querySelectorAll(".profile-section").forEach((section) => {
        section.classList.remove("active");
      });

      // Hide all book sections
      document.querySelectorAll(".books-section").forEach((section) => {
        section.style.display = "none";
      });

      // Hide stats cards
      document.getElementById("stats-cards").style.display = "none";

      // Show the selected section
      document.getElementById(`${sectionId}-section`).classList.add("active");

      // If showing username section, populate current username
      if (sectionId === "change-username") {
        document.getElementById("current-username").value =
          document.getElementById("username").textContent;
      }

      // Close the profile menu on mobile
      if (window.innerWidth <= 1024) {
        toggleProfileMenu();
      }
    }

    async function changeUsername(event) {
      event.preventDefault();

      const newUsername = document.getElementById("new-username").value;
      const confirmPassword = document.getElementById(
        "username-confirm-password"
      ).value;
      const messageEl = document.getElementById("username-message");

      // Basic validation
      if (newUsername.length < 3) {
        showMessage(
          messageEl,
          "Username must be at least 3 characters",
          "error"
        );
        return;
      }

      if (!confirmPassword) {
        showMessage(
          messageEl,
          "Please enter your password to confirm",
          "error"
        );
        return;
      }

      const button = event.target.querySelector('button[type="submit"]');
      const originalText = button.innerHTML;
      button.innerHTML = '<span class="loading-spinner"></span> Updating...';
      button.disabled = true;

      try {
        const token = localStorage.getItem("token");
        const response = await fetch("/api/user/change-username", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            newUsername,
            password: confirmPassword,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          showMessage(messageEl, "Username updated successfully!", "success");
          // Update the username display
          document.getElementById("username").textContent = newUsername;
          document.getElementById("welcome-username").textContent =
            newUsername;
          document.getElementById("current-username").value = newUsername;
          // Clear form
          document.getElementById("new-username").value = "";
          document.getElementById("username-confirm-password").value = "";

          // Update token if the server returned a new one
          if (result.token) {
            localStorage.setItem("token", result.token);
          }
        } else {
          showMessage(
            messageEl,
            result.error || "Failed to update username",
            "error"
          );
        }
      } catch (error) {
        console.error("Error changing username:", error);
        showMessage(messageEl, "Network error. Please try again.", "error");
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    async function changePassword(event) {
      event.preventDefault();

      const currentPassword =
        document.getElementById("current-password").value;
      const newPassword = document.getElementById("new-password").value;
      const confirmPassword =
        document.getElementById("confirm-password").value;
      const messageEl = document.getElementById("password-message");

      // Validation
      if (newPassword.length < 4) {
        showMessage(
          messageEl,
          "Password must be at least 4 characters",
          "error"
        );
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage(messageEl, "New passwords do not match", "error");
        return;
      }

      const button = event.target.querySelector('button[type="submit"]');
      const originalText = button.innerHTML;
      button.innerHTML = '<span class="loading-spinner"></span> Updating...';
      button.disabled = true;

      try {
        const token = localStorage.getItem("token");
        const response = await fetch("/api/user/change-password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({
            currentPassword,
            newPassword,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          showMessage(messageEl, "Password updated successfully!", "success");
          // Clear form
          document.getElementById("current-password").value = "";
          document.getElementById("new-password").value = "";
          document.getElementById("confirm-password").value = "";

          // Update token if the server returned a new one
          if (result.token) {
            localStorage.setItem("token", result.token);
          }
        } else {
          showMessage(
            messageEl,
            result.error || "Failed to update password",
            "error"
          );
        }
      } catch (error) {
        console.error("Error changing password:", error);
        showMessage(messageEl, "Network error. Please try again.", "error");
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = `form-message ${type}`;
      setTimeout(() => {
        element.className = "form-message";
        element.textContent = "";
      }, 5000);
    }

    // Function to update statistics (mock implementation)
    function updateStats() {
      // In a real app, these would come from API calls
      document.getElementById("borrowed-count").textContent = "5";
      document.getElementById("pending-count").textContent = "2";
      document.getElementById("read-count").textContent = "12";
      document.getElementById("days-remaining").textContent = "14";
    }

    // Function to fetch available books
    async function fetchAvailableBooks() {
      try {
        // Show loading state
        const booksGrid = document.getElementById("books-grid");
        booksGrid.innerHTML =
          '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x" style="color: var(--gray-light);"></i><p style="margin-top: 15px;">Loading books...</p></div>';

        const response = await fetch("/api/books");
        const books = await response.json();
        booksGrid.innerHTML = "";

        if (books.length === 0) {
          booksGrid.innerHTML =
            '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-book-open fa-2x" style="color: var(--gray-light);"></i><p style="margin-top: 15px;">No books available at the moment</p></div>';
          return;
        }

        books.forEach((book) => {
          const bookCard = document.createElement("div");
          bookCard.className = "book-card";
          bookCard.innerHTML = `
  <div class="book-header">
    <div class="book-icon">
      <i class="fas fa-book"></i>
    </div>
    <div class="book-info">
      <h3>${book.title}</h3>
      <p>${book.author}</p>
    </div>
  </div>
  <div class="book-details">
    <div class="book-detail-item">
      <span class="label">ISBN:</span>
      <span class="value">${book.isbn}</span>
    </div>
    <div class="book-detail-item">
      <span class="label">Category:</span>
      <span class="value">${book.category || "General"}</span>
    </div>
    <div class="book-detail-item">
      <span class="label">Available:</span>
      <span class="value">${book.availableCopies} copies</span>
    </div>
  </div>
  <div class="book-actions">
    <input type="number" class="days-input" min="7" max="30" value="14" placeholder="Days">
    <button class="btn-primary" onclick="requestBook('${book._id}', this)">
      <i class="fas fa-plus-circle"></i> Request
    </button>
  </div>
`;
          booksGrid.appendChild(bookCard);
        });

        // Add search functionality
        document
          .getElementById("book-search")
          .addEventListener("input", function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const bookCards = booksGrid.querySelectorAll(".book-card");

            bookCards.forEach((card) => {
              const title = card
                .querySelector("h3")
                .textContent.toLowerCase();
              const author = card
                .querySelector("p:nth-of-type(1)")
                .textContent.toLowerCase();

              if (title.includes(searchTerm) || author.includes(searchTerm)) {
                card.style.display = "block";
              } else {
                card.style.display = "none";
              }
            });
          });
      } catch (error) {
        console.error("Error fetching books:", error);
        booksGrid.innerHTML =
          '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-exclamation-triangle fa-2x" style="color: var(--danger-color);"></i><p style="margin-top: 15px;">Failed to load books. Please try again.</p></div>';
      }
    }

    // Function to fetch user's borrowed books
    // Function to fetch user's borrowed books
    async function fetchMyBooks() {
      try {
        const myBooksGrid = document.getElementById("my-books-grid");
        myBooksGrid.innerHTML =
          '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 15px;">Loading your books...</p></div>';

        const token = localStorage.getItem("token");
        if (!token) throw new Error("No token found");

        const response = await fetch("/api/user/books", {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!response.ok) throw new Error("Failed to fetch books");

        const books = await response.json();
        myBooksGrid.innerHTML = "";

        if (books.length === 0) {
          myBooksGrid.innerHTML =
            '<div class="empty-state">' +
            '  <i class="fas fa-book-open"></i>' +
            "  <h3>No Books Borrowed</h3>" +
            "  <p>You haven't borrowed any books yet</p>" +
            "</div>";
          return;
        }

        books.forEach((book) => {
          const dueDate = new Date(book.dueDate);
          const currentDate = new Date();
          const isExpired =
            currentDate > dueDate || book.status === "Expired";
          const isPending = book.status === "Pending Renewal";
          const daysRemaining = Math.ceil(
            (dueDate - currentDate) / (1000 * 60 * 60 * 24)
          );

          const statusClass = isPending
            ? "status-pending"
            : isExpired
              ? "status-expired"
              : "status-active";
          const statusText = isPending
            ? "Pending Renewal"
            : isExpired
              ? "Expired"
              : `Due in ${daysRemaining} day${daysRemaining !== 1 ? "s" : ""}`;

          const bookCard = document.createElement("div");
          bookCard.className = "book-card";
          bookCard.setAttribute(
            "data-status",
            isPending ? "pending" : isExpired ? "expired" : "active"
          );
          bookCard.innerHTML = `
          <div class="book-header">
            <div class="book-icon">
              <i class="fas fa-book"></i>
            </div>
            <div class="book-info">
              <h3>${book.title}</h3>
              <p>${book.author}</p>
            </div>
          </div>
          <div class="book-details">
            <div class="book-detail-item">
              <span class="label">Due Date:</span>
              <span class="value">${dueDate.toLocaleDateString()}</span>
            </div>
            <div class="book-detail-item">
              <span class="label">Status:</span>
              <span class="value"><span class="status-badge ${statusClass}">${statusText}</span></span>
            </div>
            ${book.isbn
              ? `
            <div class="book-detail-item">
              <span class="label">ISBN:</span>
              <span class="value">${book.isbn}</span>
            </div>`
              : ""
            }
          </div>
          <div class="book-actions">
            ${isPending || isExpired
              ? `
              <input type="number" class="days-input" min="7" max="30" value="14" placeholder="Days">
              <button class="btn-primary" onclick="renewBook('${book._id
              }', this)" ${isPending ? "disabled" : ""}>
                <i class="fas fa-sync-alt"></i> ${isPending ? "Pending..." : "Renew"
              }
              </button>
            `
              : `
              ${book.link
                ? `
                <button class="btn-primary" onclick="handleBookLink('${book.link}')">
                  <i class="fas fa-book-open"></i> Read
                </button>
              `
                : ""
              }
            `
            }
          </div>
        `;
          myBooksGrid.appendChild(bookCard);
        });

        // Add filter event listener
        document
          .getElementById("book-filter")
          .addEventListener("change", function (e) {
            const filterValue = e.target.value;
            const bookCards = myBooksGrid.querySelectorAll(".book-card");

            bookCards.forEach((card) => {
              const status = card.getAttribute("data-status");
              if (filterValue === "all" || status === filterValue) {
                card.style.display = "block";
              } else {
                card.style.display = "none";
              }
            });

            // Update count display
            const visibleCount = myBooksGrid.querySelectorAll(
              '.book-card[style="display: block"]'
            ).length;
            document.getElementById(
              "my-books-count"
            ).textContent = `(${visibleCount})`;
          });

        // Update initial count
        document.getElementById(
          "my-books-count"
        ).textContent = `(${books.length})`;
      } catch (error) {
        console.error("Error fetching my books:", error);
        myBooksGrid.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error Loading Books</h3>
          <p>${error.message}</p>
        </div>
      `;
      }
    }

    function handleBookLink(link) {
      try {
        if (!link) {
          alert("This book does not have an associated reading link");
          return;
        }

        // Validate and format the URL
        let validLink = link;
        if (!link.startsWith("http://") && !link.startsWith("https://")) {
          validLink = "https://" + link;
        }

        // Open in new tab
        window.open(validLink, "_blank", "noopener,noreferrer");
      } catch (error) {
        console.error("Error opening book link:", error);
        alert("Could not open the book link. Please try again later.");
      }
    }

    async function renewBook(bookId, button) {
      const userId = localStorage.getItem("userId");
      const daysInput = button.previousElementSibling;
      const days = parseInt(daysInput.value);

      if (!days || days < 7 || days > 30) {
        alert("Please enter a valid number of days (7-30).");
        daysInput.focus();
        return;
      }

      // Show loading state on button
      const originalText = button.innerHTML;
      button.innerHTML =
        '<span class="loading-spinner"></span> Processing...';
      button.disabled = true;

      try {
        const response = await fetch("/api/books/renew", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentId: userId, bookId, days }),
        });

        const result = await response.json();
        if (response.ok) {
          // Show success message
          const toast = document.createElement("div");
          toast.className = "toast success"; // Use the CSS class instead of inline styles
          toast.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <span>Book requested successfully!</span>
            `;
          document.body.appendChild(toast);

          // Show the toast
          setTimeout(() => toast.classList.add("show"), 10);

          // Remove after delay
          setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
          }, 3000);

          // Refresh available books
          fetchAvailableBooks();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error("Error renewing book:", error);
        alert("Failed to send request. Please try again.");
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    // Function to update expired books in the database
    async function updateBookStatus(bookId) {
      try {
        await fetch("/api/user/updateBookStatus", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ bookId }),
        });
      } catch (error) {
        console.error("Error updating book status:", error);
      }
    }

    // Function to show different sections
    function showSection(sectionId) {
      document.querySelectorAll(".books-section").forEach((section) => {
        section.style.display = "none";
      });
      document.getElementById(sectionId).style.display = "block";

      // Hide all profile sections
      document.querySelectorAll(".profile-section").forEach((section) => {
        section.classList.remove("active");
      });

      // Show stats cards
      document.getElementById("stats-cards").style.display = "block";

      // Update active nav link
      document.querySelectorAll(".nav-right a").forEach((link) => {
        link.classList.remove("active");
      });
      event.target.classList.add("active");

      // Refresh data when switching sections
      if (sectionId === "my-books") {
        fetchMyBooks();
      } else if (sectionId === "available-books") {
        fetchAvailableBooks();
      }
    }

    // Function to request a book
    async function requestBook(bookId, button) {
      const userId = localStorage.getItem("userId");
      const daysInput = button.previousElementSibling;
      const days = parseInt(daysInput.value);

      if (!days || days < 7 || days > 30) {
        alert("Please enter a valid number of days (7-30).");
        daysInput.focus();
        return;
      }

      // Show loading state on button
      const originalText = button.innerHTML;
      button.innerHTML =
        '<span class="loading-spinner"></span> Processing...';
      button.disabled = true;

      try {
        const response = await fetch("/api/requests", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ studentId: userId, bookId, days }),
        });

        const result = await response.json();
        if (response.ok) {
          // Show success message
          const toast = document.createElement("div");
          toast.className = "toast success"; // Use the CSS class instead of inline styles
          toast.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>Book requested successfully!</span>
          `;
          document.body.appendChild(toast);

          // Show the toast
          setTimeout(() => toast.classList.add("show"), 10);

          // Remove after delay
          setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 300);
          }, 3000);

          // Refresh available books
          fetchAvailableBooks();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        console.error("Error requesting book:", error);
        alert("Failed to send request. Please try again.");
      } finally {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    async function updateStats() {
      try {
        const token = localStorage.getItem("token");
        if (!token) {
          console.log("No token found");
          return;
        }

        // Show loading state
        document.getElementById("borrowed-count").innerHTML =
          '<i class="fas fa-spinner fa-spin"></i>';
        document.getElementById("active-count").innerHTML =
          '<i class="fas fa-spinner fa-spin"></i>';
        document.getElementById("expired-count").innerHTML =
          '<i class="fas fa-spinner fa-spin"></i>';

        const response = await fetch("/api/student/stats", {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || "Failed to fetch stats");
        }

        // Update the UI with real data
        document.getElementById("borrowed-count").textContent =
          data.borrowedCount || 0;
        document.getElementById("active-count").textContent =
          data.activeCount || 0;
        document.getElementById("expired-count").textContent =
          data.expiredCount || 0;
      } catch (error) {
        console.error("Error updating stats:", error);
        // Show error state
        document.getElementById("borrowed-count").innerHTML =
          '<i class="fas fa-exclamation-triangle" title="Error loading"></i>';
        document.getElementById("active-count").innerHTML =
          '<i class="fas fa-exclamation-triangle" title="Error loading"></i>';
        document.getElementById("expired-count").innerHTML =
          '<i class="fas fa-exclamation-triangle" title="Error loading"></i>';

        // Set default values after delay
        setTimeout(() => {
          document.getElementById("borrowed-count").textContent = "0";
          document.getElementById("active-count").textContent = "0";
          document.getElementById("expired-count").textContent = "0";
        }, 2000);
      }
    }

    // Function to handle logout
    function logout() {
      // Show confirmation dialog
      if (confirm("Are you sure you want to logout?")) {
        // Show loading state
        const logoutBtn = document.querySelector('a[onclick="logout()"]');
        const originalText = logoutBtn.innerHTML;
        logoutBtn.innerHTML =
          '<span class="loading-spinner"></span> Logging out...';
        logoutBtn.onclick = null; // Disable further clicks during logout

        fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include", // Important for cookies
        })
          .then(async (response) => {
            const data = await response.json();
            if (!response.ok) {
              throw new Error(data.message || "Logout failed");
            }

            // Clear client-side tokens if stored in localStorage
            localStorage.removeItem("token");
            sessionStorage.removeItem("token");

            // Redirect to home page
            window.location.href = "/";
          })
          .catch((error) => {
            console.error("Error logging out:", error);
            alert(error.message || "Failed to logout");
          })
          .finally(() => {
            logoutBtn.innerHTML = originalText;
            logoutBtn.onclick = logout; // Re-enable the button
          });
      }
    }

    // Also update your HTML to include the expired count element (replace the stats-container section)

    // Initialize dashboard
    document.addEventListener("DOMContentLoaded", () => {
      fetchUserData();
      fetchAvailableBooks();
      updateStats();

      // Set default section based on URL hash
      const hash = window.location.hash.substring(1);
      if (hash === "my-books") {
        showSection("my-books");
      } else {
        showSection("available-books");
      }

      // Add event listeners for mobile menu
      document.addEventListener("click", function (event) {
        const sidebar = document.getElementById("sidebar");
        const mobileToggle = document.querySelector(".mobile-menu-toggle");

        // Close mobile menu when clicking outside
        if (
          sidebar.classList.contains("open") &&
          !sidebar.contains(event.target) &&
          !mobileToggle.contains(event.target)
        ) {
          closeMobileMenu();
        }
      });

      // Handle window resize
      window.addEventListener("resize", function () {
        if (window.innerWidth > 1024) {
          closeMobileMenu();
        }
      });

      // Add touch/swipe support for mobile
      let touchStartX = 0;
      let touchEndX = 0;

      document.addEventListener("touchstart", function (event) {
        touchStartX = event.changedTouches[0].screenX;
      });

      document.addEventListener("touchend", function (event) {
        touchEndX = event.changedTouches[0].screenX;
        handleSwipe();
      });

      function handleSwipe() {
        const sidebar = document.getElementById("sidebar");
        const swipeThreshold = 50;

        if (touchEndX < touchStartX - swipeThreshold) {
          // Swipe left - close menu
          if (sidebar.classList.contains("open")) {
            closeMobileMenu();
          }
        } else if (touchEndX > touchStartX + swipeThreshold) {
          // Swipe right - open menu (only if on mobile)
          if (
            window.innerWidth <= 1024 &&
            !sidebar.classList.contains("open")
          ) {
            toggleMobileMenu();
          }
        }
      }
    });
  </script>
  <script>
    async function fetchNotifications() {
  try {
    const token = localStorage.getItem('token');
    if (!token) return;

    const updatesList = document.getElementById('updates-list');
    updatesList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading updates...</p>
      </div>
    `;

    const response = await fetch('/api/user/notifications', {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!response.ok) throw new Error('Failed to fetch notifications');

    const notifications = await response.json();

    if (notifications.length === 0) {
      updatesList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-bell-slash"></i>
          <p>No updates yet</p>
        </div>
      `;
      return;
    }

    updatesList.innerHTML = '';
    notifications.forEach(notification => {
      const updateItem = document.createElement('div');
      updateItem.className = `update-item ${notification.isRead ? '' : 'unread'}`;
      updateItem.dataset.id = notification._id;
      
      const timeAgo = timeSince(new Date(notification.createdAt));
      
      updateItem.innerHTML = `
        <div class="update-content">${notification.message}</div>
        <div class="update-time">${timeAgo}</div>
        <div class="update-actions">
          <button class="update-action" onclick="markAsRead('${notification._id}', this)">
            <i class="fas fa-check"></i> Mark read
          </button>
        </div>
      `;
      
      updatesList.appendChild(updateItem);
    });
  } catch (error) {
    console.error('Error fetching notifications:', error);
    const updatesList = document.getElementById('updates-list');
    updatesList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Failed to load updates</p>
      </div>
    `;
  }
}

// Helper function to format time
function timeSince(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  let interval = Math.floor(seconds / 31536000);
  if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s") + " ago";
  
  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s") + " ago";
  
  interval = Math.floor(seconds / 86400);
  if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";
  
  interval = Math.floor(seconds / 3600);
  if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s") + " ago";
  
  interval = Math.floor(seconds / 60);
  if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s") + " ago";
  
  return Math.floor(seconds) + " second" + (seconds === 1 ? "" : "s") + " ago";
}

// Mark notification as read
async function markAsRead(notificationId, button) {
  try {
    const token = localStorage.getItem('token');
    if (!token) return;

    const response = await fetch(`/api/user/notifications/${notificationId}/read`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` }
    });

    if (response.ok) {
      const item = button.closest('.update-item');
      item.classList.remove('unread');
      button.remove();
    }
  } catch (error) {
    console.error('Error marking notification as read:', error);
  }
}

// Mark all notifications as read
async function markAllAsRead() {
  try {
    const token = localStorage.getItem('token');
    if (!token) return;

    const button = event.currentTarget;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading-spinner"></span> Updating...';
    button.disabled = true;

    const response = await fetch('/api/user/notifications/read-all', {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` }
    });

    if (response.ok) {
      document.querySelectorAll('.update-item.unread').forEach(item => {
        item.classList.remove('unread');
        const actions = item.querySelector('.update-actions');
        if (actions) actions.remove();
      });
    }
  } catch (error) {
    console.error('Error marking all as read:', error);
  } finally {
    button.innerHTML = originalText;
    button.disabled = false;
  }
}

function showProfileSection(sectionId) {
  // Hide all profile sections
  document.querySelectorAll('.profile-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Hide all book sections
  document.querySelectorAll('.books-section').forEach(section => {
    section.style.display = 'none';
  });
  
  // Show the selected section
  const section = document.getElementById(`${sectionId}-section`);
  section.classList.add('active');
  
  // If showing username section, populate current username
  if (sectionId === 'change-username') {
    document.getElementById('current-username').value = 
      document.getElementById('username').textContent;
  }
  
  // If showing updates, fetch them
  if (sectionId === 'recent-updates') {
    fetchNotifications();
  }
  
  // Close the profile menu on mobile
  if (window.innerWidth <= 1024) {
    toggleProfileMenu();
  }
}
// Call this periodically (every 5 minutes) and when showing updates
setInterval(checkUnreadNotifications, 5 * 60 * 1000);

async function checkUnreadNotifications() {
  try {
    const token = localStorage.getItem('token');
    if (!token) return;

    const response = await fetch('/api/user/notifications/unread-count', {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (response.ok) {
      const data = await response.json();
      const badge = document.getElementById('notification-badge');
      if (data.count > 0) {
        badge.textContent = data.count;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
  } catch (error) {
    console.error('Error checking unread notifications:', error);
  }
}
</script>
</body>
</html>